rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Calendarios compartidos
    match /calendars/{calendarId} {
      allow read, write: if request.auth != null;

      // Días del calendario
      match /days/{dayId} {
        allow read: if request.auth != null;

        allow create, update: if request.auth != null
          && request.resource.data.keys().hasOnly([
            "lunch", "dinner", "updatedAt", "updatedBy"
          ])
          && request.resource.data.lunch is string
          && request.resource.data.dinner is string
          && request.resource.data.updatedBy is string
          && request.resource.data.updatedAt is timestamp;

        allow delete: if request.auth != null;
      }

      // Lista de la compra y categorías personalizadas
      match /shopping/{docId} {
        allow read: if request.auth != null;

        // Documento: items
        allow create, update: if request.auth != null
          && docId == "items"
          && request.resource.data.keys().hasOnly([
            "items", "updatedAt", "updatedBy"
          ])
          && request.resource.data.items is list
          && request.resource.data.updatedBy is string
          && request.resource.data.updatedAt is timestamp;

        // Documento: customCategories
        allow create, update: if request.auth != null
          && docId == "customCategories"
          && request.resource.data.keys().hasOnly([
            "categories", "updatedAt", "updatedBy"
          ])
          && request.resource.data.categories is map
          && request.resource.data.updatedBy is string
          && request.resource.data.updatedAt is timestamp;

        // Documento: suggestions
        allow create, update: if request.auth != null
          && docId == "suggestions"
          && request.resource.data.keys().hasOnly([
            "suggestions", "updatedAt", "updatedBy"
          ])
          && request.resource.data.suggestions is list
          && request.resource.data.updatedBy is string
          && request.resource.data.updatedAt is timestamp;

        allow delete: if request.auth != null;
      }

      // Recetas guardadas
      match /recipes/{docId} {
        allow read: if request.auth != null;

        allow create, update: if request.auth != null
          && docId == "items"
          && request.resource.data.keys().hasOnly([
            "recipes", "updatedAt", "updatedBy"
          ])
          && request.resource.data.recipes is list
          && request.resource.data.updatedBy is string
          && request.resource.data.updatedAt is timestamp;

        allow delete: if request.auth != null;
      }
    }
  }
}
